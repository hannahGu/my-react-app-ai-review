name: Frontend Code Review
on: [pull_request]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js çŽ¯å¢ƒ
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install ESLint
        run: npm install eslint@8.56.0

      - name: Run ESLint with Strict Rules
        run: |
          npx eslint src --max-warnings 0 \
            --rule 'react-hooks/exhaustive-deps: error' \
            --rule 'react/no-danger: error' \
            --format json --output-file eslint-report.json || true
          # ç¡®ä¿æŠ¥å‘Šæ–‡ä»¶å­˜åœ¨
          [ -s "eslint-report.json" ] || echo '[]' > eslint-report.json

      # 4. è¿è¡Œä»£ç å®¡æŸ¥
      - name: Run Frontend Review
        run: |
          echo "::group::ðŸ“Š Frontend Code Review Report"
          # ESLint æ£€æŸ¥
          eslint "src/**/*.{js,jsx,ts,tsx}" --format json --output-file eslint-report.json || true
          
          # ç”Ÿæˆæ˜“è¯»æŠ¥å‘Š
          echo "### ðŸ›  ESLint é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          jq -r '.[] | "\(.filePath):\(.messages[].line) \(.messages[].message)"' eslint-report.json >> $GITHUB_STEP_SUMMARY
          
          # ç®€å•ç»„ä»¶åˆ†æž
          echo "### ðŸ§© React ç»„ä»¶ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          grep -r "function Component" src/ | wc -l | xargs echo "- æ‰¾åˆ°çš„ç»„ä»¶æ•°é‡:" >> $GITHUB_STEP_SUMMARY
          echo "::endgroup::"


      - name: Analyze with OpenAI
        run: |
          curl https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${{ secrets.OPENAI_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "gpt-4",
              "messages": [{
                "role": "user",
                "content": "Review this code:\n```$(cat src/App.js)```\nFocus on: 1. Performance 2. Readability"
              }]
            }' > ai-report.json
          
          jq '.choices[0].message.content' ai-report.json >> $GITHUB_STEP_SUMMARY