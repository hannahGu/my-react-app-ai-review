name: Frontend Code Review
on: [pull_request]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js çŽ¯å¢ƒ
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install ESLint
        run: npm install eslint@8.56.0

      - name: Run ESLint with Strict Rules
        run: |
          npx eslint src --max-warnings 0 \
            --rule 'react-hooks/exhaustive-deps: error' \
            --rule 'react/no-danger: error' \
            --format json --output-file eslint-report.json || true
          # ç¡®ä¿æŠ¥å‘Šæ–‡ä»¶å­˜åœ¨
          [ -s "eslint-report.json" ] || echo '[]' > eslint-report.json

      # 4. è¿è¡Œä»£ç å®¡æŸ¥
      - name: Run Frontend Review
        run: |
          echo "::group::ðŸ“Š Frontend Code Review Report"
          # ESLint æ£€æŸ¥
          eslint "src/**/*.{js,jsx,ts,tsx}" --format json --output-file eslint-report.json || true
          
          # ç”Ÿæˆæ˜“è¯»æŠ¥å‘Š
          echo "### ðŸ›  ESLint é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          jq -r '.[] | "\(.filePath):\(.messages[].line) \(.messages[].message)"' eslint-report.json >> $GITHUB_STEP_SUMMARY
          
          # ç®€å•ç»„ä»¶åˆ†æž
          echo "### ðŸ§© React ç»„ä»¶ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          grep -r "function Component" src/ | wc -l | xargs echo "- æ‰¾åˆ°çš„ç»„ä»¶æ•°é‡:" >> $GITHUB_STEP_SUMMARY
          echo "::endgroup::"

      # 5. è¾“å‡ºç»“æžœåˆ°PRè¯„è®º
      - name: Create PR Comment
        uses: actions/github-script@v6
        if: always()
        with:
          script: |
            const report = require('./eslint-report.json');
            const issues = report.reduce((sum, file) => sum + file.messages.length, 0);
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ” Copilot å‰ç«¯å®¡æŸ¥ç»“æžœ:\n\n` +
                    `â€¢ ESLint é—®é¢˜: ${issues} å¤„\n` +
                    `â€¢ æŸ¥çœ‹è¯¦æƒ…: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
            });

      - name: Add AI Review Comments
        uses: actions/github-script@v6
        with:
          script: |
            // æ¨¡æ‹ŸAIå»ºè®®ï¼ˆå®žé™…éœ€æŽ¥å…¥LLM APIï¼‰
            const suggestions = [
              {
                path: 'src/App.js',
                line: 12,
                body: "å»ºè®®ä½¿ç”¨ `useCallback` ä¼˜åŒ–æ€§èƒ½ï¼š\n```suggestion\nconst handleClick = useCallback(() => {...}, []);\n```"
              }
            ];
            
            await Promise.all(suggestions.map(suggestion => 
              github.rest.pulls.createReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                commit_id: context.sha,
                path: suggestion.path,
                line: suggestion.line,
                body: suggestion.body
              })
            ));

      - name: Analyze with OpenAI
        run: |
          curl https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${{ secrets.OPENAI_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "gpt-4",
              "messages": [{
                "role": "user",
                "content": "Review this code:\n```$(cat src/App.js)```\nFocus on: 1. Performance 2. Readability"
              }]
            }' > ai-report.json
          
          jq '.choices[0].message.content' ai-report.json >> $GITHUB_STEP_SUMMARY